from shutil import copyfile
import numpy as np
from analysisConfig.changeAttr import main as attr_change

input_dir = 'UrQMD_b1_10_WithBias_CorVetoM35_Full'#UrQMD_b1_10_Full'#'ApproxSn112CorVs'
proj = 112
iter_samples = 100000
tot_samples = -1

"""
Don't change anything below
"""

rule all:
  input:
    'data/%s/Final_PhiCor_graph.root' % input_dir,
    'data/%s/Res.txt' % input_dir

rule IterPIDMeta:
  input:
    'Prior/Meta_SimSn%dTemplate.root' % proj,
    'analysisConfig/analysisSimSn%dCMWithPions.xml' % proj
  output:
    'Prior/Meta_Sn%d{input_dir}.root' % proj,
    temp('analysisConfig/analysisSimSn%dCM{input_dir}_temp.xml' % proj),
    temp('data/{input_dir}/TempFinal_ana.root'),
  run:
    with open(input[1]) as f:
      data = f.read()
    data = data.replace('Prior/Meta_SimSn%dKanekoMult50.root' % proj, output[0])
    with open(output[1], 'wt') as f:
      f.write(data)

    # seed of the iteration
    copyfile(input[0], output[0])
    args = {'Dir': os.path.join('data', input_dir) + '/',
            'rmTask' : ['EfficiencyTask', 'SimpleGraphsTask', 'ReactionPlaneTask', 'ERATTask'],
            'execarg': 'TempFinal false %d true' % iter_samples,
            'exec': True}
    for i in range(3):
      attr_change(output[1], args)

rule IterUnfold:
  input:
    'Unfolding/SimSn%dTemplate.root' % proj,
    'analysisConfig/analysisSimSn%dCMWithPions.xml' % proj,
    'Prior/Meta_Sn%d{input_dir}.root' % proj
  output:
    'Unfolding/Sn%d{input_dir}.root' % proj,
    temp('analysisConfig/analysisSimSn%dCM{input_dir}_temp.xml' % proj),
    temp('data/{input_dir}/TempFinal_ana.root'),
  run:
    with open(input[1]) as f:
      data = f.read()
    data = data.replace('Prior/Meta_SimSn%dKanekoMult50.root' % proj, input[2])
    data = data.replace('SimSn%dUnfold.root' % proj, os.path.basename(output[0]))
    with open(output[1], 'wt') as f:
      f.write(data)

    # seed of the iteration
    copyfile(input[0], output[0])
    args = {'Dir': os.path.join('data', input_dir)+ '/',
            'rmTask' : ['SimpleGraphsTask', 'ReactionPlaneTask', 'ERATTask'],
            'execarg': 'TempFinal true %d false' % iter_samples,
            'exec': True}
    for i in range(3):
      attr_change(output[1], args)

def input_for_status(wcs):
  input = ['analysisConfig/analysisSimSn%dCMWithPions.xml' % proj,
           'Prior/Meta_Sn%d' % proj + wcs.input_dir + '.root',
           'Unfolding/Sn%d' % proj + wcs.input_dir + '.root']
  if wcs.status != 'NoPhiEff':
    input = input + ['PhiEff/SimSn%d' % proj + wcs.input_dir + '.root']
  if wcs.status == 'Second':
    input = input + ['data/' + wcs.input_dir + '/Final_First_ana.root']
  return input
    
rule analysis:
  input:
    files = input_for_status
  output:
    'analysisConfig/analysisSimSn%dCM{input_dir}_{status}.xml' % proj,
    'data/{input_dir}/Final_{status}_ana.root'
  run:
    with open(input[0]) as f:
      data = f.read()
    data = data.replace('Prior/Meta_SimSn%dKanekoMult50.root' % proj, input[1])
    data = data.replace('SimSn%dUnfold.root' % proj, os.path.basename(input[2]))
    with open(output[0], 'wt') as f:
      f.write(data)

    args = {'Dir': os.path.join('data',input_dir) + '/',
            'PhiEff': None if wildcards.status == 'NoPhiEff' else input.files[3],
            'Divide': True if wildcards.status == 'First' or wildcards.status == 'Second' else False,
            'Comp': input.files[4] if wildcards.status == 'Second' else None,
            'execarg': 'Final_%s false %d' % (wildcards.status, tot_samples),
            'exec': True}
    attr_change(output[0], args)

rule PhiEff:
  input:
    'data/{input_dir}/Final_NoPhiEff_ana.root',
  output:
    'PhiEff/SimSn%d{input_dir}.root' % proj
  shell:
    '''
    root -b -l -q 'submissionScript/GetPhiEff.C({{"{input}"}},"{output}",8,20)' || true
    '''

rule ReactionPlaneResolution:
  input:
    first = 'data/{input_dir}/Final_First_ana.root',
    second = 'data/{input_dir}/Final_Second_ana.root'
  output:
    'data/{input_dir}/Res.txt'
  shell:
    '''
    root -b -l -q 'submissionScript/GetRPRes.C({{"{input.first}"}},{{"{input.second}"}})' > {output}
    '''

rule GetAccurateGraph:
  input:
    'data/{input_dir}/Final_PhiCor_ana.root'
  output:
    'data/{input_dir}/Final_PhiCor_graph.root'
  shell:
    '''
    root -b -l -q 'run_analysis_graph.C("{input_dir}/Final_PhiCor")' || true
    '''
